#!/bin/bash

# Скрипт для резервного копирования

# Проверяем, правильное ли количество аргументов передано
if [ $# -ne 3 ]; then
    echo "Использование: $0 <директория_или_файл_источника> <директория_назначения> <лог_файл>"
    exit 1
fi

# Присваиваем аргументы переменным
SOURCE=$1
DEST_DIR=$2
LOG_FILE=$3
DATE=$(date +'%Y-%m-%d_%H-%M-%S')        # Метка времени для резервной копии
BACKUP_NAME="backup_$DATE.tar.gz"        # Имя файла резервной копии

# Проверяем, существует ли директория назначения, и создаем ее, если она отсутствует
if [ ! -d "$DEST_DIR" ]; then
    mkdir -p "$DEST_DIR"
fi

# Записываем начало процесса резервного копирования в лог-файл
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Начало резервного копирования $SOURCE" >> "$LOG_FILE"

# Определяем, является ли источник директорией или файлом
if [ -d "$SOURCE" ]; then
    # Если источник - директория
    tar -czf "$DEST_DIR/$BACKUP_NAME" -C "$SOURCE" .
elif [ -f "$SOURCE" ]; then
    # Если источник - файл
    tar -czf "$DEST_DIR/$BACKUP_NAME" -C "$(dirname "$SOURCE")" "$(basename "$SOURCE")"
else
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] Ошибка: $SOURCE не является допустимым файлом или директорией." >> "$LOG_FILE"
    exit 1
fi

# Проверяем, было ли резервное копирование успешным
if [ $? -eq 0 ]; then
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] Резервное копирование успешно: $BACKUP_NAME" >> "$LOG_FILE"
else
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] Резервное копирование не удалось!" >> "$LOG_FILE"
    exit 1
fi

# Дополнительно: удаляем резервные копии, старше 7 дней
find "$DEST_DIR" -type f -name "*.tar.gz" -mtime +7 -exec rm {} \;

# Записываем завершение процесса резервного копирования в лог-файл
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Резервное копирование завершено." >> "$LOG_FILE"

exit 0
